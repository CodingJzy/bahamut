// Author: Antoine Mercadal
// See LICENSE file for full LICENSE
// Copyright 2016 Aporeto.

package bahamut

import (
	"net/http"

	"golang.org/x/net/websocket"

	"github.com/aporeto-inc/elemental"
)

// CheckAuthentication checks if the current context has been authenticated if there is any authenticator registered.
//
// If it is not authenticated it stops the normal processing execution flow, and will write the Unauthorized response to the given writer.
// If not Authenticator is set, then it will always return true.
//
// This is mostly used by autogenerated code, and you should not need to use it manually.
func CheckAuthentication(authenticator Authenticator, ctx *Context, w http.ResponseWriter) bool {

	if authenticator == nil {
		return true
	}

	ok, err := authenticator.IsAuthenticated(ctx)

	if err != nil {
		WriteHTTPError(w, ctx.Info.Headers.Get("Origin"), err)
		return false
	}

	if !ok {
		WriteHTTPError(w, ctx.Info.Headers.Get("Origin"), elemental.NewError("Unauthorized", "You are not authorized to access this resource.", "bahamut", http.StatusUnauthorized))
		return false
	}

	return true
}

// CheckWebSocketAuthentication checks if the current context has been authenticated if there is any authenticator registered.
//
// If it is not authenticated it stops the normal processing execution flow, and will write the Unauthorized response to the given writer.
// If not Authenticator is set, then it will always return true.
//
// This is mostly used by autogenerated code, and you should not need to use it manually.
func CheckWebSocketAuthentication(authenticator Authenticator, ctx *Context, response *elemental.Response, ws *websocket.Conn) bool {

	if authenticator == nil {
		return true
	}

	ok, err := authenticator.IsAuthenticated(ctx)

	if err != nil {
		writeWebSocketError(ws, response, err)
		return false
	}

	if !ok {
		writeWebSocketError(ws, response, elemental.NewError("Unauthorized", "You are not authorized to access this resource.", "bahamut", http.StatusUnauthorized))
		return false
	}

	return true
}

// CheckAuthorization checks if the current context has been authorized if there is any authorizer registered.
//
// If it is not authorized it stops the normal processing execution flow, and will write the Unauthorized response to the given writer.
// If not Authorizer is set, then it will always return true.
//
// This is mostly used by autogenerated code, and you should not need to use it manually.
func CheckAuthorization(authorizer Authorizer, ctx *Context, w http.ResponseWriter) bool {

	if authorizer == nil {
		return true
	}

	ok, err := authorizer.IsAuthorized(ctx)

	if err != nil {
		WriteHTTPError(w, ctx.Info.Headers.Get("Origin"), elemental.NewError("Internal Server Error", err.Error(), "bahamut", http.StatusInternalServerError))
		return false
	}

	if !ok {
		WriteHTTPError(w, ctx.Info.Headers.Get("Origin"), elemental.NewError("Forbidden", "You are not allowed to access this resource.", "bahamut", http.StatusForbidden))
		return false
	}

	return true
}

// CheckWebSocketAuthorization checks if the current context has been authorized if there is any authorizer registered.
//
// If it is not authorized it stops the normal processing execution flow, and will write the Unauthorized response to the given writer.
// If not Authorizer is set, then it will always return true.
//
// This is mostly used by autogenerated code, and you should not need to use it manually.
func CheckWebSocketAuthorization(authorizer Authorizer, ctx *Context, response *elemental.Response, ws *websocket.Conn) bool {

	if authorizer == nil {
		return true
	}

	ok, err := authorizer.IsAuthorized(ctx)

	if err != nil {
		writeWebSocketError(ws, response, elemental.NewError("Internal Server Error", err.Error(), "bahamut", http.StatusInternalServerError))
		return false
	}

	if !ok {
		writeWebSocketError(ws, response, elemental.NewError("Forbidden", "You are not allowed to access this resource.", "bahamut", http.StatusForbidden))
		return false
	}

	return true
}
