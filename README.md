# Bahamut

Bahamut is is Go library that provides everything you need to set up a full blown API server based on a [Elemental](https://github.com/aporeto-inc/elemental) model generated from some [Monolithe](https://github.com/aporeto-inc/monolithe) specifications.

The main concept of Bahamut is to only write core business logic, and letting it handle all the  boring bookkeeping. You can implement various Processors interfaces, and register them when you start a Bahamut Server.

The included Monolithe plugin generates all the needed routes and handlers to reroute the client requests to the correct method of the correct processor. Those handlers will perform basic operations, like validating the request's data are conform to the specifications, etc. When your processor is finally called, you can be sure that all basic errors has been previously checked and that you can safely assume everything is ready to be stored, retrieved, or whatever.

A Bahamut Server is not directly responsible for storing an retrieving data. To do so, you can use any backend library you like in your processors, but we recommend using [Manipulate](https://github.com/aporeto-inc/manipulate), which provides a common interface for manipulating data and multiple implementations for MongoDB, Cassandra or MemDB (with more to come). Later on, switching from Cassandra to MongoDB will be a no brainer.

An full example of a simple Todo List application can be found [in the example folder](https://github.com/aporeto-inc/bahamut/tree/master/example)



## Prerequisites

Install Monolithe and the Bahamut plugin:

    $ pip install 'git+https://github.com/aporeto-inc/monolithe.git'
    $ pip install 'git+ssh://git@github.com/aporeto-inc/bahamut.git#subdirectory=monolithe'



## Installation

To get the Bahamut Go Library, Run:

    $ go get -u github.com/aporeto-inc/bahamut



## Getting Started

This section explains how to build a very simple Bahamut application from scratch. It will serve one single API `GET /greetings` api that will return the quote of the day from a third party service.

> NOTE: Using Bahamut for such a simple example is of course completely overkill :)

> NOTE: You should be confortable with the concepts of Monolithe, before going further.


### Project Structure

A commonly used file structure for a Bahamut project is usually the following:

    handlers/
    models/
    processors/
    routes/
    specs/
    main.go

- The `handlers` folder will be populated by autogenerated handlers.
- The `models` folder will be populated by the autogenerated Elemental model files.
- The `processors` folder contains your implementation of the processors.
- The `routes` folder will be populated by autogenerated routes.
- The `specs` folder contains the Monolithe Specifications.

Let's create this structure:

```bash
mkdir -p {models,handlers,processors,routes,specs}
touch specs/api.info specs/monolithe.ini specs/root.spec specs/greeting.spec
touch processors/greetings.go
touch main.go
```

> NOTE: the following example assumes your source code path  is `$GOPATH/src/github.com/aporeto-inc/greetings`. You want to use something different, you'll need to adapt the example.


#### Monolithe Specification

First we need to describe our service by creating the Monolithe Specification.

> NOTE: The GUI called Specification Director is available to deal with more complex Specification, but for this example, plain text is sufficient.

Edit `specs/monolithe.ini`:

```ini
[monolithe]
product_name = Greetings

[transformer]
output = codegen
name = models
version = 1.0

[bahamut]
base_package = github.com/aporeto-inc/greetings
models_package_package = github.com/aporeto-inc/greetings/models
handlers_package_name = handlers
models_package_name = models
routes_package_name = routes
```

Edit `specs/api.info`:

```json
{
  "prefix": "api",
  "root": "root",
  "version": "1.0"
}
```

Edit `specs/root.spec`:

```json
{
    "attributes": [],
    "children": [
        {
            "get": true,
            "create": true,
            "relationship": "root",
            "rest_name": "greeting"
        }
    ],
    "model": {
        "entity_name": "Root",
        "resource_name": "root",
        "rest_name": "root",
        "root": true,
        "get": true
    }
}
```

Finally, edit `specs/greeting.spec`:

```json
{
    "attributes": [
        {
            "description": "The content message",
            "exposed": true,
            "name": "message",
            "type": "string"
        }
    ],
    "children": [],
    "model": {
        "description": "Represent a greeting message.",
        "extends": [],
        "package": "main",
        "resource_name": "greetings",
        "rest_name": "greeting",
        "entity_name": "Greeting"
    }
}
```

This specification describes a single read-only object API `/greetings` that returns a list of `greeting` that contains a `message`.

To generate and install the Elemental model from the specification, run:

```bash
monogen -f specs -L elemental
cp codegen/elemental/1.0/*.go models
```

To generate and install the Bahamut routes and handlers from the specification, run:

```bash
monogen -f specs -L bahamut
cp -a codegen/bahamut/1.0/handlers/*.go handlers
cp -a codegen/bahamut/1.0/routes/*.go routes
```

> NOTE: You can take a look at the autogenerated code in the `models`, `handlers` and `routes` packages.

> NOTE: You can safely delete the `codegen` directory after having generated what you need.


#### The Greetings Processor

A processor is responsible for anything that is not obvious from the specs. It can be creating more objects, storing them into a DB, or whatever you like.

We are going to use a simple online quote service to return a random quote as the greeting message.

As you can see this processor only implements the `RetrieveManyProcessor` interface.

Edit `processors/greetings.go`:

```go
package processors

import (
	"encoding/json"
	"net/http"
	"strconv"

	"github.com/aporeto-inc/bahamut"
	"github.com/aporeto-inc/greetings/models"
)

// GreetingsProcessor processes greetings requests.
type GreetingsProcessor struct{}

// NewGreetingsProcessor returns a new greetings processor.
func NewGreetingsProcessor() *GreetingsProcessor {
	return &GreetingsProcessor{}
}

// ProcessRetrieveMany retrieves a list of quotes.
func (p *GreetingsProcessor) ProcessRetrieveMany(ctx *bahamut.Context) error {

	n := 1

	// Check if we have a the parameter "n" asking for more than
	// one quote.
	if ns := ctx.Info.Parameters.Get("n"); ns != "" {
		var err error
		n, err = strconv.Atoi(ns)
		if err != nil {
			return err
		}
	}

	// Initialize the models.GreetingsList
	greetings := models.GreetingsList{}

	// Create a type structure for unmarshaling the quote.
	var data []struct{ Content string }

	for i := 0; i < n; i++ {

		// Retrieve the quote.
		resp, err := http.Get("https://quotesondesign.com/wp-json/posts?filter[orderby]=rand")
		if err != nil {
			return err
		}

		// Unmarshal the quote.
		if err := json.NewDecoder(resp.Body).Decode(&data); err != nil {
			return err
		}

		// Create a new Greeting object and set its message
		g := models.NewGreeting()
		g.Message = data[0].Content

		// Append the new Greeting to the GreetingLists.
		greetings = append(greetings, g)
	}

	// Set the output data of the context that will be returned to the user.
	ctx.OutputData = greetings

	// Happily return no error.
	return nil
}
```


#### The Main file

The `main.go` is responsible to configure and start your Bahamut server. A very simple `main.go` could look like this:

```go
package main

import (
	"github.com/aporeto-inc/bahamut"

	"github.com/aporeto-inc/greetings/handlers"
	"github.com/aporeto-inc/greetings/models"
	"github.com/aporeto-inc/greetings/processors"
	"github.com/aporeto-inc/greetings/routes"
)

func main() {

  // Create a Bahamut server with a minimal Bahamut API configuration and an empty push config.
	server := bahamut.NewServer(
		bahamut.APIServerConfig{
			ListenAddress: ":9999",
			Routes:        routes.Routes(),
		},
		bahamut.PushServerConfig{},
	)

	// Tells your autogenerated handlers what Bahamut server they are using.
	handlers.SetBahamutServer(server)

	// Register your hello processor for the HelloIdentity.
	server.RegisterProcessor(processors.NewGreetingsProcessor(), models.GreetingIdentity)

	// And start the server.
	server.Start()
}
```

### Try it

Now run

```bash
go build && ./greetings
```

The try it:

```bash
curl http://127.0.0.1:9999/greetings?n=2 | jq

[
  {"message": "Design is the body language of your marketing. Don't slouch."},
  {"message": "There is an unmistakeable difference between a bag of rabbit parts and a rabbit."}
]

```

## What's next?

You can check a more advanced example in the example folder of this repository.

Have fun!
